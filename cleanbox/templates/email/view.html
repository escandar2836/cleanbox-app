{% extends "base.html" %}

{% block title %}CleanBox - 이메일 상세{% endblock %}

{% block extra_css %}
<style>
.email-content {
    font-family: inherit;
    line-height: 1.6;
    max-width: 100%;
    overflow-x: auto;
}

.email-content img {
    max-width: 100%;
    height: auto;
}

.email-content table {
    border-collapse: collapse;
    width: 100%;
    margin: 10px 0;
}

.email-content table, .email-content th, .email-content td {
    border: 1px solid #ddd;
}

.email-content th, .email-content td {
    padding: 8px;
    text-align: left;
}

.email-content a {
    color: #007bff;
    text-decoration: underline;
}

.email-content blockquote {
    border-left: 4px solid #ddd;
    margin: 10px 0;
    padding-left: 15px;
    color: #666;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card cleanbox-card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-envelope"></i> 이메일 상세</h5>
                    <div>
                        <a href="{{ url_for('email.list_emails') }}" class="btn btn-light btn-sm">
                            <i class="fas fa-arrow-left"></i> 목록으로
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- 이메일 헤더 -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h4>{{ email.subject }}</h4>
                            <p class="text-muted mb-1">
                                <i class="fas fa-user"></i> {{ email.sender }}
                            </p>
                            <p class="text-muted mb-2">
                                <i class="fas fa-clock"></i> 
                                {{ email.received_at.strftime('%Y년 %m월 %d일 %H:%M') if email.received_at else email.created_at.strftime('%Y년 %m월 %d일 %H:%M') }}
                            </p>
                        </div>
                        <div class="btn-group">
                            {% if not email.is_read %}
                            <a href="{{ url_for('email.mark_as_read', email_id=email.id) }}" class="btn btn-success btn-sm">
                                <i class="fas fa-check"></i> 읽음 표시
                            </a>
                            {% endif %}
                            {% if not email.is_archived %}
                            <a href="{{ url_for('email.archive_email', email_id=email.id) }}" class="btn btn-warning btn-sm">
                                <i class="fas fa-archive"></i> 아카이브
                            </a>
                            {% endif %}
                            <button class="btn btn-info btn-sm" onclick="analyzeEmail({{ email.id }})">
                                <i class="fas fa-robot"></i> AI 분석
                            </button>
                            {% if not email.is_unsubscribed %}
                            <button class="btn btn-danger btn-sm" onclick="unsubscribeEmail({{ email.id }})">
                                <i class="fas fa-unlink"></i> 구독 해지
                            </button>
                            {% else %}
                            <button class="btn btn-secondary btn-sm" disabled>
                                <i class="fas fa-check"></i> 이미 해지됨
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- 카테고리 정보 -->
                    <div class="mb-3">
                        {% if category %}
                        <span class="badge" style="background-color: {{ category.color }};">
                            <i class="{{ category.icon }}"></i> {{ category.name }}
                        </span>
                        {% else %}
                        <span class="badge bg-secondary">미분류</span>
                        {% endif %}
                        
                        <!-- 카테고리 변경 -->
                        <div class="dropdown d-inline-block ms-2">
                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-edit"></i> 분류 변경
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="changeCategory({{ email.id }}, 0)">미분류</a></li>
                                {% for cat in categories %}
                                <li><a class="dropdown-item" href="#" onclick="changeCategory({{ email.id }}, {{ cat.id }})">
                                    <i class="{{ cat.icon }}" style="color: {{ cat.color }};"></i> {{ cat.name }}
                                </a></li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- AI 요약 -->
                {% if email.summary %}
                <div class="alert alert-info">
                    <h6><i class="fas fa-robot"></i> AI 요약</h6>
                    <p class="mb-0">{{ email.summary }}</p>
                </div>
                {% endif %}
                
                <!-- 이메일 본문 -->
                <div class="mb-4">
                    <h6><i class="fas fa-file-alt"></i> 이메일 내용</h6>
                    <div class="border rounded p-3 bg-light">
                        <div class="email-content">
                            {{ email.content|safe }}
                        </div>
                    </div>
                </div>
                
                <!-- 이메일 정보 -->
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle"></i> 이메일 정보</h6>
                        <ul class="list-unstyled">
                            <li><strong>Gmail ID:</strong> {{ email.gmail_id }}</li>
                            {% if email.thread_id %}
                            <li><strong>Thread ID:</strong> {{ email.thread_id }}</li>
                            {% endif %}
                            <li><strong>상태:</strong> 
                                {% if email.is_read %}
                                <span class="badge bg-success">읽음</span>
                                {% else %}
                                <span class="badge bg-warning">읽지 않음</span>
                                {% endif %}
                            </li>
                            <li><strong>아카이브:</strong> 
                                {% if email.is_archived %}
                                <span class="badge bg-info">아카이브됨</span>
                                {% else %}
                                <span class="badge bg-secondary">활성</span>
                                {% endif %}
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-chart-bar"></i> 통계</h6>
                        <ul class="list-unstyled">
                            <li><strong>생성일:</strong> {{ email.created_at.strftime('%Y년 %m월 %d일 %H:%M') }}</li>
                            <li><strong>수정일:</strong> {{ email.updated_at.strftime('%Y년 %m월 %d일 %H:%M') }}</li>
                            <li><strong>내용 길이:</strong> {{ email.content|length }}자</li>
                            {% if email.summary %}
                            <li><strong>요약 길이:</strong> {{ email.summary|length }}자</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI 분석 모달 -->
<div class="modal fade" id="analysisModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-robot"></i> AI 분석 결과</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="analysisContent">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">분석 중...</span>
                    </div>
                    <p class="mt-2">AI가 이메일을 분석하고 있습니다...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- 구독 해지 모달 -->
<div class="modal fade" id="unsubscribeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-unlink"></i> 구독 해지 진행</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="unsubscribeContent">
                <div class="text-center">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">구독 해지 중...</span>
                    </div>
                    <p class="mt-2">AI가 구독 해지 링크를 찾아 처리하고 있습니다...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<script>
// 카테고리 변경 함수
function changeCategory(emailId, categoryId) {
    const formData = new FormData();
    formData.append('category_id', categoryId);
    
    fetch(`/email/${emailId}/classify`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // 페이지 새로고침
        } else {
            alert('카테고리 변경 실패: ' + data.message);
        }
    })
    .catch(error => {
        alert('오류: ' + error);
    });
}

// AI 분석 함수
function analyzeEmail(emailId) {
    const modal = new bootstrap.Modal(document.getElementById('analysisModal'));
    modal.show();
    
    fetch(`/email/${emailId}/analyze`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayAnalysis(data.analysis);
            } else {
                document.getElementById('analysisContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> ${data.message}
                    </div>
                `;
            }
        })
        .catch(error => {
            document.getElementById('analysisContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> 분석 중 오류가 발생했습니다: ${error}
                </div>
            `;
        });
}

// 분석 결과 표시 (구조화된 요약)
function displayAnalysis(analysis) {
    const content = document.getElementById('analysisContent');
    
    let categoryHtml = '';
    if (analysis.category_name && analysis.category_name !== '미분류') {
        categoryHtml = `
            <div class="col-md-6">
                <h6><i class="fas fa-tag"></i> 분류 결과</h6>
                <div class="mb-3">
                    <span class="badge bg-primary">${analysis.category_name}</span>
                </div>
            </div>
        `;
    }
    
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-file-alt"></i> AI 요약</h6>
                <div class="small" style="white-space: pre-line;">${analysis.summary}</div>
            </div>
            ${categoryHtml}
        </div>
    `;
}

// 구독 해지 함수
function unsubscribeEmail(emailId) {
    if (!confirm('이 이메일의 구독을 해지하시겠습니까?\n\nAI가 자동으로 구독 해지 링크를 찾아 처리합니다.')) {
        return;
    }
    
    // 모달 표시
    const modal = new bootstrap.Modal(document.getElementById('unsubscribeModal'));
    modal.show();
    
    // 구독 해지 요청
    fetch(`/email/${emailId}/unsubscribe`)
        .then(response => response.json())
        .then(data => {
            const modalBody = document.getElementById('unsubscribeContent');
            
            if (data.success) {
                modalBody.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h5 class="text-success">구독 해지 완료!</h5>
                        <p>${data.message}</p>
                        ${data.steps ? `<div class="mt-3"><strong>처리 단계:</strong><ul class="text-start">${data.steps.map(step => `<li>${step}</li>`).join('')}</ul></div>` : ''}
                    </div>
                `;
                
                // 페이지 새로고침으로 상태 업데이트
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                modalBody.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <h5 class="text-danger">구독 해지 실패</h5>
                        <p>${data.message}</p>
                        ${data.steps ? `<div class="mt-3"><strong>시도한 단계:</strong><ul class="text-start">${data.steps.map(step => `<li>${step}</li>`).join('')}</ul></div>` : ''}
                    </div>
                `;
            }
        })
        .catch(error => {
            const modalBody = document.getElementById('unsubscribeContent');
            modalBody.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                    <h5 class="text-danger">오류 발생</h5>
                    <p>구독 해지 처리 중 오류가 발생했습니다.</p>
                    <small class="text-muted">${error.message}</small>
                </div>
            `;
        });
}
</script>
{% endblock %} 