{% extends "base.html" %}

{% block title %}CleanBox - ì´ë©”ì¼ ìƒì„¸{% endblock %}

{% block extra_css %}
<style>
.email-content {
    font-family: inherit;
    line-height: 1.6;
    max-width: 100%;
    overflow-x: auto;
}

.email-content img {
    max-width: 100%;
    height: auto;
}

.email-content table {
    border-collapse: collapse;
    width: 100%;
    margin: 10px 0;
}

.email-content table, .email-content th, .email-content td {
    border: 1px solid #ddd;
}

.email-content th, .email-content td {
    padding: 8px;
    text-align: left;
}

.email-content a {
    color: #007bff;
    text-decoration: underline;
}

.email-content blockquote {
    border-left: 4px solid #ddd;
    margin: 10px 0;
    padding-left: 15px;
    color: #666;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card cleanbox-card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-envelope"></i> ì´ë©”ì¼ ìƒì„¸</h5>
                    <div>
                        <a href="{{ url_for('email.list_emails') }}" class="btn btn-light btn-sm">
                            <i class="fas fa-arrow-left"></i> ëª©ë¡ìœ¼ë¡œ
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- ì´ë©”ì¼ í—¤ë” -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h4>{{ email.subject }}</h4>
                            <p class="text-muted mb-1">
                                <i class="fas fa-user"></i> {{ email.sender }}
                            </p>
                            <p class="text-muted mb-2">
                                <i class="fas fa-clock"></i> 
                                {{ email.received_at.strftime('%Yë…„ %mì›” %dì¼ %H:%M') if email.received_at else email.created_at.strftime('%Yë…„ %mì›” %dì¼ %H:%M') }}
                            </p>
                        </div>
                        <div class="btn-group">
                            {% if not email.is_read %}
                            <a href="{{ url_for('email.mark_as_read', email_id=email.id) }}" class="btn btn-success btn-sm">
                                <i class="fas fa-check"></i> ì½ìŒ í‘œì‹œ
                            </a>
                            {% endif %}
                            {% if not email.is_archived %}
                            <a href="{{ url_for('email.archive_email', email_id=email.id) }}" class="btn btn-warning btn-sm">
                                <i class="fas fa-archive"></i> ì•„ì¹´ì´ë¸Œ
                            </a>
                            {% endif %}
                            <button class="btn btn-info btn-sm" onclick="analyzeEmail({{ email.id }})">
                                <i class="fas fa-robot"></i> AI ë¶„ì„
                            </button>
                            {% if not email.is_unsubscribed %}
                            <button class="btn btn-danger btn-sm" onclick="unsubscribeEmail({{ email.id }})">
                                <i class="fas fa-unlink"></i> êµ¬ë… í•´ì§€
                            </button>
                            {% else %}
                            <button class="btn btn-secondary btn-sm" disabled>
                                <i class="fas fa-check"></i> ì´ë¯¸ í•´ì§€ë¨
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- ì¹´í…Œê³ ë¦¬ ì •ë³´ -->
                    <div class="mb-3">
                        {% if category %}
                        <span class="badge" style="background-color: {{ category.color }};">
                            <i class="{{ category.icon }}"></i> {{ category.name }}
                        </span>
                        {% else %}
                        <span class="badge bg-secondary">ë¯¸ë¶„ë¥˜</span>
                        {% endif %}
                        
                        <!-- ì¹´í…Œê³ ë¦¬ ë³€ê²½ -->
                        <div class="dropdown d-inline-block ms-2">
                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-edit"></i> ë¶„ë¥˜ ë³€ê²½
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="changeCategory({{ email.id }}, 0)">ë¯¸ë¶„ë¥˜</a></li>
                                {% for cat in categories %}
                                <li><a class="dropdown-item" href="#" onclick="changeCategory({{ email.id }}, {{ cat.id }})">
                                    <i class="{{ cat.icon }}" style="color: {{ cat.color }};"></i> {{ cat.name }}
                                </a></li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- AI ìš”ì•½ -->
                {% if email.summary %}
                <div class="alert alert-info">
                    <h6><i class="fas fa-robot"></i> AI ìš”ì•½</h6>
                    <p class="mb-0">{{ email.summary }}</p>
                </div>
                {% endif %}
                
                <!-- ì´ë©”ì¼ ë³¸ë¬¸ -->
                <div class="mb-4">
                    <h6><i class="fas fa-file-alt"></i> ì´ë©”ì¼ ë‚´ìš©</h6>
                    <div class="border rounded p-3 bg-light">
                        <div class="email-content">
                            {{ email.content|safe }}
                        </div>
                    </div>
                </div>
                
                <!-- ì´ë©”ì¼ ì •ë³´ -->
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle"></i> ì´ë©”ì¼ ì •ë³´</h6>
                        <ul class="list-unstyled">
                            <li><strong>Gmail ID:</strong> {{ email.gmail_id }}</li>
                            {% if email.thread_id %}
                            <li><strong>Thread ID:</strong> {{ email.thread_id }}</li>
                            {% endif %}
                            <li><strong>ìƒíƒœ:</strong> 
                                {% if email.is_read %}
                                <span class="badge bg-success">ì½ìŒ</span>
                                {% else %}
                                <span class="badge bg-warning">ì½ì§€ ì•ŠìŒ</span>
                                {% endif %}
                            </li>
                            <li><strong>ì•„ì¹´ì´ë¸Œ:</strong> 
                                {% if email.is_archived %}
                                <span class="badge bg-info">ì•„ì¹´ì´ë¸Œë¨</span>
                                {% else %}
                                <span class="badge bg-secondary">í™œì„±</span>
                                {% endif %}
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-chart-bar"></i> í†µê³„</h6>
                        <ul class="list-unstyled">
                            <li><strong>ìƒì„±ì¼:</strong> {{ email.created_at.strftime('%Yë…„ %mì›” %dì¼ %H:%M') }}</li>
                            <li><strong>ìˆ˜ì •ì¼:</strong> {{ email.updated_at.strftime('%Yë…„ %mì›” %dì¼ %H:%M') }}</li>
                            <li><strong>ë‚´ìš© ê¸¸ì´:</strong> {{ email.content|length }}ì</li>
                            {% if email.summary %}
                            <li><strong>ìš”ì•½ ê¸¸ì´:</strong> {{ email.summary|length }}ì</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI ë¶„ì„ ëª¨ë‹¬ -->
<div class="modal fade" id="analysisModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-robot"></i> AI ë¶„ì„ ê²°ê³¼</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="analysisContent">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">ë¶„ì„ ì¤‘...</span>
                    </div>
                    <p class="mt-2">AIê°€ ì´ë©”ì¼ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<!-- êµ¬ë… í•´ì§€ ëª¨ë‹¬ -->
<div class="modal fade" id="unsubscribeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-unlink"></i> êµ¬ë… í•´ì§€ ì§„í–‰</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="unsubscribeContent">
                <div class="text-center">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">êµ¬ë… í•´ì§€ ì¤‘...</span>
                    </div>
                    <p class="mt-2">AIê°€ êµ¬ë… í•´ì§€ ë§í¬ë¥¼ ì°¾ì•„ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script>
// ì¹´í…Œê³ ë¦¬ ë³€ê²½ í•¨ìˆ˜
function changeCategory(emailId, categoryId) {
    const formData = new FormData();
    formData.append('category_id', categoryId);
    
    fetch(`/email/${emailId}/classify`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        } else {
            alert('ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì‹¤íŒ¨: ' + data.message);
        }
    })
    .catch(error => {
        alert('ì˜¤ë¥˜: ' + error);
    });
}

// AI ë¶„ì„ í•¨ìˆ˜
function analyzeEmail(emailId) {
    const modal = new bootstrap.Modal(document.getElementById('analysisModal'));
    modal.show();
    
    fetch(`/email/${emailId}/analyze`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayAnalysis(data.analysis);
            } else {
                document.getElementById('analysisContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> ${data.message}
                    </div>
                `;
            }
        })
        .catch(error => {
            document.getElementById('analysisContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error}
                </div>
            `;
        });
}

// ë¶„ì„ ê²°ê³¼ í‘œì‹œ (êµ¬ì¡°í™”ëœ ìš”ì•½)
function displayAnalysis(analysis) {
    const content = document.getElementById('analysisContent');
    
    let categoryHtml = '';
    if (analysis.category_name && analysis.category_name !== 'ë¯¸ë¶„ë¥˜') {
        categoryHtml = `
            <div class="col-md-6">
                <h6><i class="fas fa-tag"></i> ë¶„ë¥˜ ê²°ê³¼</h6>
                <div class="mb-3">
                    <span class="badge bg-primary">${analysis.category_name}</span>
                </div>
            </div>
        `;
    }
    
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-file-alt"></i> AI ìš”ì•½</h6>
                <div class="small" style="white-space: pre-line;">${analysis.summary}</div>
            </div>
            ${categoryHtml}
        </div>
    `;
}

// êµ¬ë… í•´ì§€ í•¨ìˆ˜
function unsubscribeEmail(emailId) {
    console.log('ğŸ” [view.html] unsubscribeEmail() í˜¸ì¶œë¨');
    console.log('ğŸ“§ ì´ë©”ì¼ ID:', emailId);
    console.log('ğŸ“§ ì´ë©”ì¼ ID íƒ€ì…:', typeof emailId);
    
    // Bootstrap í™•ì¸ ë° ê°œì„ ëœ ì²˜ë¦¬
    if (typeof bootstrap === 'undefined') {
        console.error('âŒ Bootstrapì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
        showFallbackAlert('Bootstrapì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'danger');
        return;
    }
    
    // ëª¨ë‹¬ ìš”ì†Œ í™•ì¸ ë° ê°œì„ ëœ ì²˜ë¦¬
    const modalElement = document.getElementById('unsubscribeModal');
    if (!modalElement) {
        console.error('âŒ êµ¬ë… í•´ì§€ ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        showFallbackAlert('ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'danger');
        return;
    }
    
    if (!confirm('ì´ ì´ë©”ì¼ì˜ êµ¬ë…ì„ í•´ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nAIê°€ ìë™ìœ¼ë¡œ êµ¬ë… í•´ì§€ ë§í¬ë¥¼ ì°¾ì•„ ì²˜ë¦¬í•©ë‹ˆë‹¤.')) {
        console.log('âŒ ì‚¬ìš©ìê°€ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤');
        return;
    }
    
    console.log('âœ… ì‚¬ìš©ì í™•ì¸ ì™„ë£Œ, ëª¨ë‹¬ í‘œì‹œ');
    
    try {
        // ëª¨ë‹¬ í‘œì‹œ
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        
        // êµ¬ë… í•´ì§€ ìš”ì²­
        const requestUrl = `/email/${emailId}/unsubscribe`;
        console.log('ğŸš€ ìš”ì²­ URL:', requestUrl);
        console.log('ğŸ“¡ fetch ìš”ì²­ ì‹œì‘');
        
        // íƒ€ì„ì•„ì›ƒ ì„¤ì • (30ì´ˆ)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        
        fetch(requestUrl, {
            signal: controller.signal
        })
        .then(response => {
            clearTimeout(timeoutId);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            handleUnsubscribeResult(data, modalElement);
        })
        .catch(error => {
            clearTimeout(timeoutId);
            console.error('êµ¬ë…í•´ì§€ ìš”ì²­ ì‹¤íŒ¨:', error);
            
            // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì¸ì§€ í™•ì¸
            if (error.name === 'AbortError') {
                handleUnsubscribeError(new Error('ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'), modalElement);
            } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                handleUnsubscribeError(new Error('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'), modalElement);
            } else {
                handleUnsubscribeError(error, modalElement);
            }
        });
    } catch (error) {
        console.error('ëª¨ë‹¬ í‘œì‹œ ì‹¤íŒ¨:', error);
        showFallbackAlert('ëª¨ë‹¬ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
    }
}

// êµ¬ë…í•´ì§€ ê²°ê³¼ ì²˜ë¦¬ í•¨ìˆ˜
function handleUnsubscribeResult(data, modalElement) {
    const modalBody = modalElement.querySelector('.modal-body');
    if (!modalBody) {
        alert('ëª¨ë‹¬ ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    if (data.success) {
        // ì¼ê´„ ì—…ë°ì´íŠ¸ ì •ë³´ í¬í•¨
        let bulkUpdateInfo = '';
        if (data.bulk_updated_count && data.bulk_updated_count > 0) {
            bulkUpdateInfo = `
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle"></i>
                    <strong>ì¼ê´„ ì—…ë°ì´íŠ¸ ì™„ë£Œ:</strong> ${data.bulk_updated_message}
                </div>
            `;
        }
        
        modalBody.innerHTML = `
            <div class="text-center">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h5 class="text-success">êµ¬ë… í•´ì§€ ì™„ë£Œ!</h5>
                <p>${data.message}</p>
                ${data.steps ? `<div class="mt-3"><strong>ì²˜ë¦¬ ë‹¨ê³„:</strong><ul class="text-start">${data.steps.map(step => `<li>${step}</li>`).join('')}</ul></div>` : ''}
                ${bulkUpdateInfo}
            </div>
        `;
        
        // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ìƒíƒœ ì—…ë°ì´íŠ¸
        setTimeout(() => {
            location.reload();
        }, 2000);
    } else {
        modalBody.innerHTML = `
            <div class="text-center">
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <h5 class="text-danger">êµ¬ë… í•´ì§€ ì‹¤íŒ¨</h5>
                <p>${data.message}</p>
                ${data.steps ? `<div class="mt-3"><strong>ì‹œë„í•œ ë‹¨ê³„:</strong><ul class="text-start">${data.steps.map(step => `<li>${step}</li>`).join('')}</ul></div>` : ''}
            </div>
        `;
    }
}

// êµ¬ë…í•´ì§€ ì˜¤ë¥˜ ì²˜ë¦¬ í•¨ìˆ˜
function handleUnsubscribeError(error, modalElement) {
    const modalBody = modalElement.querySelector('.modal-body');
    if (!modalBody) {
        alert('ëª¨ë‹¬ ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    modalBody.innerHTML = `
        <div class="text-center">
            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
            <h5 class="text-danger">ì˜¤ë¥˜ ë°œìƒ</h5>
            <p>êµ¬ë… í•´ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
            <small class="text-muted">${error.message}</small>
        </div>
    `;
}

// í´ë°± ì•Œë¦¼ í•¨ìˆ˜ (ëª¨ë‹¬ì´ ì—†ì„ ë•Œ ì‚¬ìš©)
function showFallbackAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'danger' ? 'exclamation-triangle' : 'info-circle'}"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    // 5ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %} 